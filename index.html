<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Taka Gor BD</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script>
        function loadAdScript(src) {
            return new Promise((resolve, reject) => {
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
    </script>
    <style>
        :root {
            --primary-color: #007bff; --primary-green: #28a745; --background-dark: #121212;
            --surface-dark: #1e1e1e; --text-light: #ffffff; --text-secondary: #b3b3b3;
            --border-color: #333333; --yellow: #ffc107; --red: #dc3545;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background-color: var(--background-dark); color: var(--text-light); overflow: hidden; -webkit-tap-highlight-color: transparent; }
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background-dark); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.8s ease; }
        .loader-profile { position: relative; width: 120px; height: 120px; margin-bottom: 20px; }
        .loader-profile-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid var(--surface-dark); box-shadow: 0 0 25px rgba(0, 123, 255, 0.6); position: relative; z-index: 2001; transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .progress-bar-container { width: 200px; height: 8px; background-color: var(--surface-dark); border-radius: 4px; overflow: hidden; }
        .progress-bar-inner { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--primary-green)); border-radius: 4px; transition: width 1.5s ease-out; }
        .container { width: 100%; max-width: 500px; margin: 0 auto; display: none; flex-direction: column; min-height: 100vh; padding-top: 60px; padding-bottom: 60px; box-sizing: border-box; }
        .header, .footer-nav { transition: transform 0.3s ease-in-out; }
        .header.hidden, .footer-nav.hidden { transform: translateY(150%); }
        .header.hidden { transform: translateY(-100%); }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; background-color: var(--surface-dark); position: fixed; top: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; z-index: 1000; border-bottom: 1px solid var(--border-color); }
        .header-profile { display: flex; align-items: center; gap: 12px; }
        .profile-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        h3 { margin: 0; font-size: 1rem; font-weight: 600; }
        p { margin: 0; font-size: 0.8rem; color: var(--text-secondary); }
        .view { display: none; flex-grow: 1; padding: 15px; animation: fadeInView 0.4s ease; overflow-y: auto; }
        .view.active { display: flex; flex-direction: column; gap: 20px; }
        @keyframes fadeInView { from { opacity: 0; } to { opacity: 1; } }
        .card { background-color: var(--surface-dark); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
        h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; text-align: center; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn:disabled { background-color: #555 !important; color: #999 !important; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stats-item { background-color: var(--surface-dark); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border-color); }
        .value { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; color: var(--primary-color); }
        .label { font-size: 0.8rem; color: var(--text-secondary); }
        .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; background-color: var(--surface-dark); display: flex; justify-content: space-around; padding: 5px 0; border-top: 1px solid var(--border-color); z-index: 1000; }
        .nav-btn { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; cursor: pointer; transition: color 0.2s; flex: 1; padding: 5px 0; }
        .nav-btn.active { color: var(--primary-color); }
        .nav-btn svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .ad-tasks-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .ad-task-button { height: 130px; background: linear-gradient(145deg, #1f1f1f, #1a1a1a); border: 1px solid var(--border-color); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; box-shadow: 5px 5px 10px #0d0d0d, -5px -5px 10px #2b2b2b; transition: all 0.3s ease; border-radius: 15px; }
        .ad-task-button:disabled { background: #2a2a2a; box-shadow: inset 2px 2px 5px #0d0d0d; color: #777; }
        .ad-task-button .icon { font-size: 2rem; margin-bottom: 8px; }
        .ad-task-button .text { font-size: 0.9rem; font-weight: 600; }
        .ad-task-button .subtext { font-size: 0.7rem; color: var(--text-secondary); }
    </style>
</head>
<body>
    <div id="preloader"><div class="loader-profile"><img id="loader-pic" src="" alt="P" class="loader-profile-pic"></div><h3 id="loader-username">...</h3><div class="progress-bar-container"><div class="progress-bar-inner" id="progressBar"></div></div></div>
    
    <div class="container" id="app-container">
        <div class="header"><div class="header-profile"><img id="headerProfilePic" src="" alt="P" class="profile-pic"><div class="user-info"><h3 id="userName">...</h3><p id="userBalanceText">...</p></div></div></div>
        
        <div id="home-view" class="view active"><div class="stats-grid"><div class="stats-item"><div class="value" id="balanceValue">0.00</div><div class="label">Balance (BDT)</div></div><div class="stats-item"><div class="value" id="adsWatchedValue">0/10</div><div class="label">Ads Watched Today</div></div></div><div class="card"><h3 style="margin-top:0;">Daily Bonus</h3><p>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßÅ‡¶®!</p><button class="btn btn-primary" id="dailyBonusBtn">Claim Bonus</button></div><div class="card"><h3 style="margin-top:0">Start Earning</h3><p>Tasks ‡¶™‡ßá‡¶ú‡ßá ‡¶ó‡¶ø‡ßü‡ßá ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ü‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p><button id="homeGoToTaskBtn" class="btn btn-primary">Go to Tasks</button></div></div>
        
        <div id="leaderboard-view" class="view"><div class="card"><h2>Top Earners</h2><div id="leaderboard-list"></div></div></div>

        <div id="tasks-view" class="view">
            <div class="card">
                <h2>Watch Ads & Earn</h2>
                <p style="text-align:center; margin-bottom: 20px;">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü: <span id="taskAdsLimit">0/10</span></p>
                <div class="ad-tasks-container">
                    <button class="ad-task-button" id="watchAdBtn1">
                        <div class="icon">üì∫</div>
                        <div class="text">Watch Ad #1</div>
                        <div class="subtext" id="adRewardText1"></div>
                    </button>
                    <button class="ad-task-button" id="watchAdBtn2">
                        <div class="icon">üé¨</div>
                        <div class="text">Watch Ad #2</div>
                        <div class="subtext" id="adRewardText2"></div>
                    </button>
                </div>
            </div>
            <div class="card">
                <h2>Other Tasks</h2>
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                     <button class="btn btn-primary" id="telegramTaskBtn"></button>
                     <button class="btn btn-primary" id="youtubeTaskBtn"></button>
                </div>
            </div>
        </div>

        <div id="withdraw-view" class="view"></div>
        <div id="profile-view" class="view"></div>

        <footer class="footer-nav">
            <button class="nav-btn active" data-view="home-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span></button>
            <button class="nav-btn" data-view="leaderboard-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M6 21h12V9H6v12zm2-10h8v8H8v-8zm8-11v2H6V3.32L12 1l6 2.32z"/></svg><span>Leaders</span></button>
            <button class="nav-btn" data-view="tasks-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.5 11H19V7h-4V5.5h4V1h-4v3h-4V1h-4v4.5H3V7h4v4H3v4.5h4V19h4v-3h4v4.5h4V19h-4v-4h1.5z"/></svg><span>Tasks</span></button>
            <button class="nav-btn" data-view="withdraw-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg><span>Withdraw</span></button>
            <button class="nav-btn" data-view="profile-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span>Profile</span></button>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCQkckxOt7CC1dvawMpBnF99GW940kitg8",
                authDomain: "promotion-app-38424.firebaseapp.com",
                projectId: "promotion-app-38424",
                storageBucket: "promotion-app-38424.appspot.com",
                messagingSenderId: "216320652641",
                appId: "1:216320652641:web:73106abf936ade4b244120"
            };
            
            let appSettings = { AD_REWARD: 0.27, DAILY_BONUS_AMOUNT: 1, MIN_WITHDRAW_AMOUNT: 50, DAILY_ADS_LIMIT: 10, TELEGRAM_JOIN_BONUS: 10, YOUTUBE_JOIN_BONUS: 15 };
            let currentUser = null;

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const tg = window.Telegram.WebApp;
            
            const getEl = (id) => document.getElementById(id);
            const elements = {
                preloader: getEl('preloader'), appContainer: getEl('app-container'),
                loaderPic: getEl('loader-pic'), loaderUsername: getEl('loader-username'),
                headerProfilePic: getEl('headerProfilePic'), userName: getEl('userName'), userBalanceText: getEl('userBalanceText'),
                balanceValue: getEl('balanceValue'), adsWatchedValue: getEl('adsWatchedValue'),
                taskAdsLimit: getEl('taskAdsLimit'),
                watchAdBtn1: getEl('watchAdBtn1'), adRewardText1: getEl('adRewardText1'),
                watchAdBtn2: getEl('watchAdBtn2'), adRewardText2: getEl('adRewardText2'),
                dailyBonusBtn: getEl('dailyBonusBtn'), navButtons: document.querySelectorAll('.nav-btn'),
                views: document.querySelectorAll('.view'), homeGoToTaskBtn: getEl('homeGoToTaskBtn'),
                telegramTaskBtn: getEl('telegramTaskBtn'), youtubeTaskBtn: getEl('youtubeTaskBtn')
            };

            const showView = (viewId) => {
                elements.views.forEach(v => v.classList.remove('active'));
                elements.navButtons.forEach(b => b.classList.remove('active'));
                getEl(viewId)?.classList.add('active');
                document.querySelector(`.nav-btn[data-view="${viewId}"]`)?.classList.add('active');
            };

            const safeToFixed = (num) => (typeof num === 'number' ? num.toFixed(2) : '0.00');

            // ‚úÖ ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
            function updateAllUI() {
                if (!currentUser) return;
                const { balance = 0, adsWatchedToday = 0, lastBonusClaimDate, claimedTasks = {} } = currentUser;
                
                elements.userBalanceText.textContent = `‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ${safeToFixed(balance)} ‡¶ü‡¶æ‡¶ï‡¶æ`;
                elements.balanceValue.textContent = safeToFixed(balance);
                elements.adsWatchedValue.textContent = `${adsWatchedToday}/${appSettings.DAILY_ADS_LIMIT}`;
                elements.taskAdsLimit.textContent = `${adsWatchedToday}/${appSettings.DAILY_ADS_LIMIT}`;
                
                elements.adRewardText1.textContent = `Earn ${appSettings.AD_REWARD.toFixed(2)} BDT`;
                elements.adRewardText2.textContent = `Earn ${appSettings.AD_REWARD.toFixed(2)} BDT`;

                const isAdLimitReached = adsWatchedToday >= appSettings.DAILY_ADS_LIMIT;
                
                // ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶ï‡ßã‡¶°: ‡¶è‡¶ñ‡¶® data-attribute ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá
                if (elements.watchAdBtn1.dataset.timerActive !== 'true') {
                    elements.watchAdBtn1.disabled = isAdLimitReached;
                }
                if (elements.watchAdBtn2.dataset.timerActive !== 'true') {
                    elements.watchAdBtn2.disabled = isAdLimitReached;
                }
                
                const today = new Date().toDateString();
                elements.dailyBonusBtn.disabled = lastBonusClaimDate === today;
                elements.dailyBonusBtn.textContent = elements.dailyBonusBtn.disabled ? 'Claimed Today' : `Claim ${appSettings.DAILY_BONUS_AMOUNT.toFixed(2)} Taka`;

                elements.telegramTaskBtn.textContent = claimedTasks.telegram ? 'Claimed' : `Claim ${appSettings.TELEGRAM_JOIN_BONUS} BDT`;
                elements.telegramTaskBtn.disabled = claimedTasks.telegram;
                elements.youtubeTaskBtn.textContent = claimedTasks.youtube ? 'Claimed' : `Claim ${appSettings.YOUTUBE_JOIN_BONUS} BDT`;
                elements.youtubeTaskBtn.disabled = claimedTasks.youtube;
            }

            try {
                tg.ready();
                tg.expand();
                const tgUser = tg.initDataUnsafe?.user;
                if (!tgUser) throw new Error("Please open via Telegram");

                const name = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim();
                const photo = tgUser.photo_url || 'https://i.ibb.co/L5k6v7R/default-profile.jpg';
                ['loader-pic', 'headerProfilePic'].forEach(id => getEl(id).src = photo);
                ['loader-username', 'userName'].forEach(id => getEl(id).textContent = name);
                
                const settingsDoc = await db.collection('settings').doc('config').get();
                if (settingsDoc.exists) appSettings = { ...appSettings, ...settingsDoc.data() };

                const userRef = db.collection('users').doc(String(tgUser.id));
                const userDoc = await userRef.get();
                const today = new Date().toDateString();
                if (!userDoc.exists) {
                    currentUser = { uid: String(tgUser.id), name, photoURL: photo, username: tgUser.username || null, balance: 0, total_earnings: 0, lastBonusClaimDate: null, adsWatchedToday: 0, lastAdWatchDate: null, claimedTasks: {} };
                    await userRef.set(currentUser);
                } else {
                    currentUser = userDoc.data();
                    if (currentUser.lastAdWatchDate !== today) {
                        currentUser.adsWatchedToday = 0;
                        await userRef.update({ adsWatchedToday: 0, lastAdWatchDate: today });
                    }
                }
                
                getEl('preloader').style.display = 'none';
                getEl('app-container').style.display = 'flex';
                updateAllUI();
                
            } catch (error) {
                console.error("Initialization Error:", error);
                document.body.innerHTML = `<div style="text-align:center;padding:20px;">Error: ${error.message}</div>`;
            }

            elements.navButtons.forEach(btn => btn.addEventListener('click', () => showView(btn.dataset.view)));
            elements.homeGoToTaskBtn.addEventListener('click', () => showView('tasks-view'));

            elements.dailyBonusBtn.addEventListener('click', async () => {
                const btn = elements.dailyBonusBtn;
                const today = new Date().toDateString();
                if (currentUser.lastBonusClaimDate === today) {
                    tg.showAlert("You have already claimed today's bonus.");
                    return;
                }
                btn.disabled = true;
                btn.textContent = 'Claiming...';
                
                const userRef = db.collection('users').doc(currentUser.uid);
                try {
                    const newBalance = (currentUser.balance || 0) + appSettings.DAILY_BONUS_AMOUNT;
                    const newTotalEarnings = (currentUser.total_earnings || 0) + appSettings.DAILY_BONUS_AMOUNT;
                    
                    await userRef.update({
                        balance: newBalance,
                        total_earnings: newTotalEarnings,
                        lastBonusClaimDate: today
                    });

                    currentUser.balance = newBalance;
                    currentUser.total_earnings = newTotalEarnings;
                    currentUser.lastBonusClaimDate = today;
                    
                    tg.showAlert(`You claimed ${appSettings.DAILY_BONUS_AMOUNT.toFixed(2)} Taka!`);
                } catch (e) {
                    tg.showAlert("Error claiming bonus. Please try again.");
                    console.error("Bonus Claim Error:", e);
                } finally {
                    updateAllUI();
                }
            });

            async function handleWatchAd(buttonElement, adProvider) {
                if (currentUser.adsWatchedToday >= appSettings.DAILY_ADS_LIMIT) {
                    tg.showAlert('Daily ad limit reached.');
                    return;
                }
                buttonElement.disabled = true;
                buttonElement.querySelector('.text').textContent = 'Loading Ad...';

                try {
                    if (adProvider === 'libtl') {
                        await loadAdScript('//libtl.com/sdk.js');
                        if (typeof show_9719927 !== 'function') throw new Error('LibTL SDK not found.');
                        show_9719927();
                    } else if (adProvider === 'gigapub') {
                        await loadAdScript('https://ad.gigapub.tech/script?id=2932');
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 8000));

                    const userRef = db.collection('users').doc(currentUser.uid);
                    const newBalance = (currentUser.balance || 0) + appSettings.AD_REWARD;
                    const newTotalEarnings = (currentUser.total_earnings || 0) + appSettings.AD_REWARD;
                    const newAdsWatched = (currentUser.adsWatchedToday || 0) + 1;
                    
                    await userRef.update({
                        balance: newBalance,
                        total_earnings: newTotalEarnings,
                        adsWatchedToday: newAdsWatched
                    });

                    currentUser = {...currentUser, balance: newBalance, total_earnings: newTotalEarnings, adsWatchedToday: newAdsWatched};
                    tg.showAlert(`Congratulations! You earned ${appSettings.AD_REWARD.toFixed(2)} Taka.`);
                    
                    startCooldown(buttonElement);
                } catch (e) {
                    tg.showAlert('Failed to show ad. Please try again.');
                    console.error("Ad Error:", e);
                    buttonElement.disabled = false;
                } finally {
                    buttonElement.querySelector('.text').textContent = `Watch Ad #${adProvider === 'libtl' ? 1 : 2}`;
                    updateAllUI();
                }
            }

            function startCooldown(buttonElement) {
                let seconds = 15;
                buttonElement.disabled = true;
                buttonElement.dataset.timerActive = 'true';
                
                const originalText = buttonElement.querySelector('.text').textContent;
                const timerElement = buttonElement.querySelector('.text');
                
                const interval = setInterval(() => {
                    timerElement.textContent = `Wait ${seconds}s`;
                    seconds--;
                    if (seconds < 0) {
                        clearInterval(interval);
                        timerElement.textContent = originalText;
                        buttonElement.dataset.timerActive = 'false';
                        updateAllUI();
                    }
                }, 1000);
            }
            
            elements.watchAdBtn1.addEventListener('click', () => handleWatchAd(elements.watchAdBtn1, 'libtl'));
            elements.watchAdBtn2.addEventListener('click', () => handleWatchAd(elements.watchAdBtn2, 'gigapub'));

            async function handleTaskClaim(taskName, bonusField, url) {
                if (currentUser.claimedTasks?.[taskName]) {
                    tg.showAlert('Bonus already claimed for this task.');
                    return;
                }
                const btn = elements[`${taskName}TaskBtn`];
                tg.openLink(url);
                btn.disabled = true;
                btn.textContent = 'Verifying...';
                
                setTimeout(async () => {
                    const userRef = db.collection('users').doc(currentUser.uid);
                    try {
                        const bonus = appSettings[bonusField];
                        const newBalance = (currentUser.balance || 0) + bonus;
                        const newTotalEarnings = (currentUser.total_earnings || 0) + bonus;
                        const newClaimedTasks = { ...currentUser.claimedTasks, [taskName]: true };

                        await userRef.update({
                            balance: newBalance,
                            total_earnings: newTotalEarnings,
                            claimedTasks: newClaimedTasks
                        });

                        currentUser = {...currentUser, balance: newBalance, total_earnings: newTotalEarnings, claimedTasks: newClaimedTasks};
                        updateAllUI();
                        tg.showAlert(`Congratulations! You received ${bonus} Taka.`);
                    } catch (e) {
                        tg.showAlert('Failed to claim bonus. Please try again.');
                        updateAllUI();
                    }
                }, 8000);
            }
            
            elements.telegramTaskBtn.addEventListener('click', () => handleTaskClaim('telegram', 'TELEGRAM_JOIN_BONUS', 'https://t.me/yourchannel'));
            elements.youtubeTaskBtn.addEventListener('click', () => handleTaskClaim('youtube', 'YOUTUBE_JOIN_BONUS', 'https://www.youtube.com/yourchannel'));
        });
    </script>
</body>
</html>
