<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Taka Gor BD</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <!-- Manual Ad SDKs -->
    <script src='//libtl.com/sdk.js' data-zone='9719927' data-sdk='show_9719927'></script>
    <script src="https://ad.gigapub.tech/script?id=2932"></script>
    <style>
        :root {
            --primary-color: #007bff; --primary-green: #28a745; --background-dark: #121212;
            --surface-dark: #1e1e1e; --text-light: #ffffff; --text-secondary: #b3b3b3;
            --border-color: #333333; --yellow: #ffc107; --red: #dc3545;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background-color: var(--background-dark); color: var(--text-light); overflow: hidden; -webkit-tap-highlight-color: transparent; }
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background-dark); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.8s ease; }
        .loader-profile { position: relative; width: 120px; height: 120px; margin-bottom: 20px; }
        .loader-profile-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid var(--surface-dark); box-shadow: 0 0 25px rgba(0, 123, 255, 0.6); position: relative; z-index: 2001; transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .loader-blast-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .blast-particle { position: absolute; background-color: var(--primary-blue); border-radius: 50%; opacity: 0; }
        #loader-username { font-size: 22px; font-weight: 600; margin-bottom: 25px; letter-spacing: 1px; }
        .progress-bar-container { width: 200px; height: 8px; background-color: var(--surface-dark); border-radius: 4px; overflow: hidden; }
        .progress-bar-inner { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--primary-green)); border-radius: 4px; transition: width 1.5s ease-out; }
        .container { width: 100%; max-width: 500px; margin: 0 auto; display: none; flex-direction: column; min-height: 100vh; padding-top: 60px; padding-bottom: 60px; box-sizing: border-box; }
        .header, .footer-nav { transition: transform 0.3s ease-in-out; }
        .header.hidden, .footer-nav.hidden { transform: translateY(150%); }
        .header.hidden { transform: translateY(-100%); }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; background-color: var(--surface-dark); position: fixed; top: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; z-index: 1000; border-bottom: 1px solid var(--border-color); box-sizing: border-box; }
        .header-profile { display: flex; align-items: center; gap: 12px; }
        .header-profile .profile-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .header-profile .user-info h3 { margin: 0; font-size: 1rem; font-weight: 600; }
        .header-profile .user-info p { margin: 0; font-size: 0.8rem; color: var(--text-secondary); }
        .view { display: none; flex-grow: 1; padding: 15px; animation: fadeInView 0.4s ease; overflow-y: auto; }
        .view.active { display: flex; flex-direction: column; gap: 20px; }
        @keyframes fadeInView { from { opacity: 0; } to { opacity: 1; } }
        .card { background-color: var(--surface-dark); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
        h2 { font-size: 1.1rem; font-weight: 600; margin: 0 0 15px 0; text-align: center; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:disabled { background-color: #555 !important; color: #999 !important; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-blue); color: white; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stats-item { background-color: var(--surface-dark); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border-color); }
        .stats-item .value { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; color: var(--primary-blue); }
        .stats-item .label { font-size: 0.8rem; color: var(--text-secondary); }
        .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; background-color: var(--surface-dark); display: flex; justify-content: space-around; padding: 5px 0; border-top: 1px solid var(--border-color); z-index: 1000; }
        .nav-btn { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; cursor: pointer; transition: color 0.2s; flex: 1; padding: 5px 0; }
        .nav-btn.active { color: var(--primary-blue); }
        .nav-btn svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; box-sizing: border-box; }
        .modal-content { background-color: var(--surface-dark); width: 100%; max-width: 400px; padding: 20px; border-radius: 12px; animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h3 { margin: 0; font-size: 1.1rem; }
        .close-modal { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .leaderboard-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; margin-bottom:10px; background-color:rgba(0,0,0,0.2); }
        .lb-rank { font-size: 1rem; font-weight: bold; color: var(--text-secondary); width: 30px; }
        .lb-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin: 0 10px; }
        .lb-name { font-weight: 600; flex-grow: 1; font-size:0.9rem; }
        .lb-balance { font-size: 1rem; font-weight: bold; color: var(--primary-green); }
        .withdraw-history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .history-info p { margin: 0; font-size:0.9rem; } .history-info .date { font-size: 0.7rem; color: var(--text-secondary); }
        .history-status { padding: 5px 10px; border-radius: 15px; font-size: 0.7rem; font-weight: bold; }
        .status-pending { background-color: var(--yellow); color: #000; }
        .status-approved { background-color: var(--primary-green); color: #fff; }
        .status-rejected { background-color: var(--red); color: #fff; }
        /* Premium Task Button */
        .task-button-wrapper { display: flex; justify-content: center; align-items: center; margin: 20px 0; }
        .task-button { position: relative; width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(145deg, #1f1f1f, #1a1a1a); border: none; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; box-shadow: 10px 10px 20px #0d0d0d, -10px -10px 20px #2b2b2b; transition: all 0.3s ease; }
        .task-button:active { box-shadow: inset 5px 5px 10px #0d0d0d, inset -5px -5px 10px #2b2b2b; }
        .task-button-ring { position: absolute; top: -10px; left: -10px; width: 170px; height: 170px; border-radius: 50%; border: 2px solid var(--primary-blue); border-left-color: transparent; animation: spin 2s linear infinite; }
        .task-button .icon { font-size: 2.5rem; margin-bottom: 5px; }
        .task-button .text { font-size: 1rem; font-weight: 600; }
        .task-button .subtext { font-size: 0.7rem; color: var(--text-secondary); }
        .task-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .small-task-card { background-color: var(--surface-dark); padding: 15px; border-radius: 10px; text-align: center; }
        .small-task-card .icon { font-size: 2rem; }
        .small-task-card p { font-size: 0.8rem; margin: 10px 0; }
        .small-task-card .btn { padding: 10px; font-size: 0.8rem; }
        /* Confetti for celebration */
        .confetti { position: fixed; width: 10px; height: 10px; background-color: var(--primary-blue); border-radius: 50%; top: 50%; left: 50%; opacity: 0; animation: confetti-blast 1s ease-out forwards; }
        @keyframes confetti-blast { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(var(--x), var(--y)) scale(0); opacity: 0; } }
    </style>
</head>
<body>
    <div id="preloader"><div class="loader-profile"><div class="loader-blast-container"></div><img id="loader-pic" src="" alt="P" class="loader-profile-pic"></div><h3 id="loader-username">...</h3><div class="progress-bar-container"><div class="progress-bar-inner" id="progressBar"></div></div></div>
    
    <div class="container" id="app-container">
        <div class="header"><div class="header-profile"><img id="headerProfilePic" src="" alt="P" class="profile-pic"><div class="user-info"><h3 id="userName">...</h3><p id="userBalanceText">...</p></div></div></div>
        
        <div id="home-view" class="view active">
            <div class="stats-grid">
                <div class="stats-item"><div class="value" id="balanceValue">0.00</div><div class="label">Balance (BDT)</div></div>
                <div class="stats-item"><div class="value" id="adsWatchedValue">0/10</div><div class="label">Ads Watched Today</div></div>
            </div>
            <div class="card"><h3 style="margin-top:0;">Daily Bonus</h3><p style="font-size: 0.8rem;">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßÅ‡¶®!</p><button class="btn btn-primary" id="dailyBonusBtn">Claim Bonus</button></div>
            <div class="card"><h3 style="margin-top:0">Start Earning</h3><p style="font-size: 0.8rem;">Tasks ‡¶™‡ßá‡¶ú‡ßá ‡¶ó‡¶ø‡ßü‡ßá ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ü‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p><button id="homeGoToTaskBtn" class="btn btn-primary">Go to Tasks</button></div>
        </div>
        
        <div id="leaderboard-view" class="view"><div class="card"><h2>Top Earners</h2><div id="leaderboard-list"></div></div></div>

        <div id="tasks-view" class="view">
            <div class="task-button-wrapper">
                <button class="task-button" id="watchAdBtn">
                    <div class="task-button-ring"></div>
                    <div class="icon">üì∫</div>
                    <div class="text">Watch Ad</div>
                    <div class="subtext" id="adRewardText">Earn 0.27 BDT</div>
                </button>
            </div>
            <div class="task-grid">
                <div class="small-task-card"><div class="icon">‚úàÔ∏è</div><p>Join Telegram</p><button class="btn btn-primary" id="telegramTaskBtn">Claim 10 BDT</button></div>
                <div class="small-task-card"><div class="icon">‚ñ∂Ô∏è</div><p>Subscribe YouTube</p><button class="btn btn-primary" id="youtubeTaskBtn">Claim 15 BDT</button></div>
            </div>
        </div>

        <div id="withdraw-view" class="view">
            <div class="card">
                <h2>Withdraw</h2>
                <div class="input-group"><label style="font-size: 0.8rem;">Amount</label><input type="number" id="withdrawAmount" placeholder="50"></div>
                <div class="input-group"><label style="font-size: 0.8rem;">Method</label><select id="withdrawMethod"><option value="bKash">bKash</option><option value="Nagad">Nagad</option></select></div>
                <div class="input-group"><label style="font-size: 0.8rem;">Number</label><input type="text" id="accountNumber" placeholder="01..."></div>
                <button class="btn btn-primary" id="submitWithdraw">Submit</button>
            </div>
            <div class="card"><h3>Withdraw History</h3><div id="withdraw-history-list"></div></div>
        </div>

        <div id="profile-view" class="view">
            <div class="card" style="align-items:center;">
                <img id="profilePic" src="" style="width:100px; height:100px; border-radius:50%;">
                <h3 id="profileName" style="margin-top: 15px;">...</h3>
                <p id="profileUsername">...</p>
            </div>
            <div class="stats-grid">
                <div class="stats-item"><div class="value" id="profileBalance">0.00</div><div class="label">Balance</div></div>
                <div class="stats-item"><div class="value" id="profileTotalEarnings">0.00</div><div class="label">Total Earned</div></div>
            </div>
             <div class="card">
                <h3>Invite Friends</h3>
                <input type="text" id="inviteLinkInput" readonly style="text-align:center; margin-bottom:10px;">
                <button class="btn btn-primary" id="copyInviteLinkBtn">Copy Invite Link</button>
            </div>
        </div>

        <footer class="footer-nav">
            <button class="nav-btn active" data-view="home-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span></button>
            <button class="nav-btn" data-view="leaderboard-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M6 21h12V9H6v12zm2-10h8v8H8v-8zm8-11v2H6V3.32L12 1l6 2.32z"/></svg><span>Leaders</span></button>
            <button class="nav-btn" data-view="tasks-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.5 11H19V7h-4V5.5h4V1h-4v3h-4V1h-4v4.5H3V7h4v4H3v4.5h4V19h4v-3h4v4.5h4V19h-4v-4h1.5z"/></svg><span>Tasks</span></button>
            <button class="nav-btn" data-view="withdraw-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg><span>Withdraw</span></button>
            <button class="nav-btn" data-view="profile-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span>Profile</span></button>
        </footer>

        <div class="modal-overlay" id="welcome-modal"><div class="modal-content"><div class="modal-header"><h3>Welcome!</h3><button class="close-modal">&times;</button></div><p id="welcome-message" style="margin-bottom:15px;"></p><button id="modal-start-earning" class="btn btn-primary">Start Earning</button></div></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCQkckxOt7CC1dvawMpBnF99GW940kitg8",
                authDomain: "promotion-app-38424.firebaseapp.com",
                projectId: "promotion-app-38424",
                storageBucket: "promotion-app-38424.appspot.com",
                messagingSenderId: "216320652641",
                appId: "1:216320652641:web:73106abf936ade4b244120"
            };
            
            const INVITE_LINK_BASE = "http://t.me/Taka_GorBD1_Bot/open";

            let appSettings = { AD_REWARD: 0.27, DAILY_BONUS_AMOUNT: 1, MIN_WITHDRAW_AMOUNT: 50, DAILY_ADS_LIMIT: 10, TELEGRAM_JOIN_BONUS: 10, YOUTUBE_JOIN_BONUS: 15, WELCOME_MESSAGE: "Welcome!" };
            let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
            let adClickCount = 0;

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const tg = window.Telegram.WebApp;

            const elements = {
                preloader: document.getElementById('preloader'), appContainer: document.getElementById('app-container'),
                loaderPic: document.getElementById('loader-pic'), loaderUsername: document.getElementById('loader-username'),
                header: document.querySelector('.header'), footerNav: document.querySelector('.footer-nav'),
                headerProfilePic: document.getElementById('headerProfilePic'), userName: document.getElementById('userName'),
                userBalanceText: document.getElementById('userBalanceText'), balanceValue: document.getElementById('balanceValue'),
                adsWatchedValue: document.getElementById('adsWatchedValue'), watchAdBtn: document.getElementById('watchAdBtn'),
                adRewardText: document.getElementById('adRewardText'), dailyBonusBtn: document.getElementById('dailyBonusBtn'),
                navButtons: document.querySelectorAll('.nav-btn'), views: document.querySelectorAll('.view'),
                homeGoToTaskBtn: document.getElementById('homeGoToTaskBtn'), leaderboardList: document.getElementById('leaderboard-list'),
                withdrawAmount: document.getElementById('withdrawAmount'), submitWithdraw: document.getElementById('submitWithdraw'),
                withdrawHistoryList: document.getElementById('withdraw-history-list'), profilePic: document.getElementById('profilePic'),
                profileName: document.getElementById('profileName'), profileUsername: document.getElementById('profileUsername'),
                profileBalance: document.getElementById('profileBalance'), profileTotalEarnings: document.getElementById('profileTotalEarnings'),
                welcomeModal: document.getElementById('welcome-modal'), welcomeMessage: document.getElementById('welcome-message'),
                closeModalBtn: document.querySelector('#welcome-modal .close-modal'), modalStartEarningBtn: document.getElementById('modal-start-earning'),
                inviteLinkInput: document.getElementById('inviteLinkInput'), copyInviteLinkBtn: document.getElementById('copyInviteLinkBtn'),
                telegramTaskBtn: document.getElementById('telegramTaskBtn'), youtubeTaskBtn: document.getElementById('youtubeTaskBtn')
            };

            const showView = (viewId) => {
                elements.views.forEach(v => v.classList.remove('active'));
                elements.navButtons.forEach(b => b.classList.remove('active'));
                document.getElementById(viewId)?.classList.add('active');
                document.querySelector(`.nav-btn[data-view="${viewId}"]`)?.classList.add('active');
            };

            function updateAllUI() {
                if (!currentUser) return;
                const { balance, adsWatchedToday, total_earnings, lastBonusClaimDate } = currentUser;
                const today = new Date().toDateString();

                elements.userBalanceText.textContent = `‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ${balance.toFixed(2)} ‡¶ü‡¶æ‡¶ï‡¶æ`;
                elements.balanceValue.textContent = balance.toFixed(2);
                elements.adsWatchedValue.textContent = `${adsWatchedToday}/${appSettings.DAILY_ADS_LIMIT}`;
                elements.adRewardText.textContent = `Earn ${appSettings.AD_REWARD.toFixed(2)} BDT`;
                elements.profileBalance.textContent = balance.toFixed(2);
                elements.profileTotalEarnings.textContent = total_earnings.toFixed(2);
                elements.profileUsername.textContent = currentUser.username ? `@${currentUser.username}` : '';
                elements.inviteLinkInput.value = INVITE_LINK_BASE;

                elements.watchAdBtn.disabled = adsWatchedToday >= appSettings.DAILY_ADS_LIMIT;
                elements.dailyBonusBtn.disabled = lastBonusClaimDate === today;
                elements.dailyBonusBtn.textContent = elements.dailyBonusBtn.disabled ? 'Claimed Today' : `Claim ${appSettings.DAILY_BONUS_AMOUNT.toFixed(2)} Taka`;
            }

            try {
                tg.ready();
                tg.expand();
                const tgUser = tg.initDataUnsafe?.user;
                if (!tgUser) throw new Error("Please open via Telegram");

                const name = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim() || 'Welcome';
                const photo = tgUser.photo_url || 'https://i.ibb.co/L5k6v7R/default-profile.jpg';
                ['loader-pic', 'headerProfilePic', 'profilePic'].forEach(id => document.getElementById(id).src = photo);
                ['loader-username', 'userName', 'profileName'].forEach(id => document.getElementById(id).textContent = name);
                
                await Promise.all([
                    (async () => { const doc = await db.collection('settings').doc('config').get(); if (doc.exists) appSettings = { ...appSettings, ...doc.data() }; })(),
                    (async () => {
                        const userRef = db.collection('users').doc(String(tgUser.id));
                        const userDoc = await userRef.get();
                        const today = new Date().toDateString();
                        if (!userDoc.exists) {
                            currentUser = { uid: String(tgUser.id), name, photoURL: photo, username: tgUser.username || null, balance: 0, total_earnings: 0, lastBonusClaimDate: null, adsWatchedToday: 0, lastAdWatchDate: null, claimedTasks: {} };
                            await userRef.set(currentUser);
                        } else {
                            currentUser = userDoc.data();
                            if (currentUser.lastAdWatchDate !== today) {
                                await userRef.update({ adsWatchedToday: 0, lastAdWatchDate: today });
                                currentUser.adsWatchedToday = 0;
                            }
                        }
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    })()
                ]);

                updateAllUI();
                finishLoadingAnimation();
                loadLeaderboard();
                loadWithdrawHistory();

            } catch (error) {
                document.getElementById('preloader').innerHTML = `<div style="text-align:center;padding:20px;">Error: ${error.message}</div>`;
            }
            
            function finishLoadingAnimation() {
                const loaderPic = elements.loaderPic;
                const blastContainer = document.querySelector('.loader-blast-container');
                for(let i=0; i<30; i++){ let p=document.createElement('div'); p.className='blast-particle'; p.style.transform=`rotate(${Math.random()*360}deg) translateX(80px) rotate(-${Math.random()*360}deg)`; p.style.transition=`all ${0.5 + Math.random()*0.5}s ease-out`; blastContainer.appendChild(p); setTimeout(()=>p.style.transform=`${p.style.transform} scale(15)`,50);}
                
                setTimeout(() => document.getElementById('progressBar').style.width = '100%', 100);
                setTimeout(() => {
                    const headerPicRect = elements.headerProfilePic.getBoundingClientRect();
                    const scale = headerPicRect.width / loaderPic.width;
                    const translateX = headerPicRect.left - loaderPic.getBoundingClientRect().left;
                    const translateY = headerPicRect.top - loaderPic.getBoundingClientRect().top;
                    loaderPic.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
                    elements.loaderUsername.style.opacity = '0';
                    elements.preloader.style.opacity = '0';
                    setTimeout(() => {
                        elements.preloader.style.display = 'none';
                        elements.appContainer.style.display = 'flex';
                        const isFirstVisit = !localStorage.getItem('visitedBefore');
                        if(isFirstVisit){ elements.welcomeMessage.textContent = appSettings.WELCOME_MESSAGE; elements.welcomeModal.style.display = 'flex'; localStorage.setItem('visitedBefore', 'true'); setTimeout(() => elements.welcomeModal.style.display = 'none', 5000); }
                    }, 800);
                }, 2000);
            }

            async function loadLeaderboard() {
                const list = elements.leaderboardList;
                list.innerHTML = 'Loading...';
                const snapshot = await db.collection('users').orderBy('total_earnings', 'desc').limit(20).get();
                list.innerHTML = '';
                snapshot.forEach((doc, index) => {
                    const user = doc.data();
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `<span class="lb-rank">${index + 1}</span><img src="${user.photoURL}" class="lb-pic"><span class="lb-name">${user.name}</span><span class="lb-balance">${user.total_earnings.toFixed(2)}</span>`;
                    list.appendChild(item);
                });
            }

            async function loadWithdrawHistory() {
                const list = elements.withdrawHistoryList;
                list.innerHTML = 'Loading...';
                const snapshot = await db.collection('withdrawals').where('uid', '==', currentUser.uid).orderBy('requestedAt', 'desc').limit(10).get();
                list.innerHTML = '';
                if(snapshot.empty) { list.innerHTML = 'No history found.'; return; }
                snapshot.forEach(doc => {
                    const req = doc.data();
                    const item = document.createElement('div');
                    item.className = 'withdraw-history-item';
                    const date = req.requestedAt.toDate().toLocaleDateString('bn-BD');
                    item.innerHTML = `<div class="history-info"><p>${req.amount.toFixed(2)} BDT via ${req.method}</p><p class="date">${date}</p></div><span class="history-status status-${req.status}">${req.status}</span>`;
                    list.appendChild(item);
                });
            }
            
            let lastScroll = 0;
            elements.views.forEach(v => v.addEventListener('scroll', () => {
                const isScrollingDown = v.scrollTop > lastScroll && v.scrollTop > 50;
                elements.header.classList.toggle('hidden', isScrollingDown);
                elements.footerNav.classList.toggle('hidden', isScrollingDown);
                lastScroll = v.scrollTop <= 0 ? 0 : v.scrollTop;
            }));

            elements.navButtons.forEach(btn => btn.addEventListener('click', () => showView(btn.dataset.view)));
            elements.homeGoToTaskBtn.addEventListener('click', () => showView('tasks-view'));
            elements.closeModalBtn.addEventListener('click', () => elements.welcomeModal.style.display = 'none');
            elements.modalStartEarningBtn.addEventListener('click', () => { elements.welcomeModal.style.display = 'none'; showView('tasks-view'); });
            elements.copyInviteLinkBtn.addEventListener('click', () => navigator.clipboard.writeText(INVITE_LINK_BASE).then(() => tg.showAlert('Invite Link Copied!')));

            elements.dailyBonusBtn.addEventListener('click', async () => { /* Logic */ });
            elements.watchAdBtn.addEventListener('click', async () => {
                elements.watchAdBtn.disabled = true;
                const adPlatform = adClickCount % 2 === 0 ? 'gigapub' : 'libtl';
                try {
                    // This is a simulation. Real SDK calls might differ.
                    if (adPlatform === 'gigapub' && typeof showGiga !== 'undefined') await showGiga();
                    else if (adPlatform === 'libtl' && typeof show_9719927 !== 'undefined') await show_9719927();
                    else await new Promise(res => setTimeout(res, 2000)); // Fallback

                    adClickCount++;
                    const userRef = db.collection('users').doc(currentUser.uid);
                    await db.runTransaction(async t => {
                        const doc = await t.get(userRef);
                        const data = doc.data();
                        const newBalance = data.balance + appSettings.AD_REWARD;
                        const newTotalEarnings = data.total_earnings + appSettings.AD_REWARD;
                        const newAdsWatched = data.adsWatchedToday + 1;
                        t.update(userRef, { balance: newBalance, total_earnings: newTotalEarnings, adsWatchedToday: newAdsWatched });
                        currentUser = {...currentUser, balance: newBalance, total_earnings: newTotalEarnings, adsWatchedToday: newAdsWatched};
                    });
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    // Confetti celebration
                    for(let i=0; i<50; i++){ let c=document.createElement('div'); c.className='confetti'; c.style.setProperty('--x', (Math.random()*400-200)+'px'); c.style.setProperty('--y', (Math.random()*400-200)+'px'); document.body.appendChild(c); setTimeout(()=>c.remove(),1000); }
                    tg.showAlert(`Congratulations! You earned ${appSettings.AD_REWARD.toFixed(2)} Taka.`);
                } catch(e) {
                    tg.showAlert('Failed to show ad. Please try again.');
                } finally {
                    updateAllUI();
                }
            });
            elements.submitWithdraw.addEventListener('click', async () => { /* Logic */ });

        });
    </script>
</body>
</html>
