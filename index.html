<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Taka Gor BD</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-blue: #007bff; --primary-green: #28a745; --background-dark: #121212;
            --surface-dark: #1e1e1e; --text-light: #ffffff; --text-secondary: #b3b3b3;
            --border-color: #333333; --yellow: #ffc107; --red: #dc3545;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 0; background-color: var(--background-dark); color: var(--text-light); overflow: hidden; -webkit-tap-highlight-color: transparent; }
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background-dark); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.8s ease; }
        .loader-profile { position: relative; width: 120px; height: 120px; margin-bottom: 20px; }
        .loader-profile-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid var(--surface-dark); box-shadow: 0 0 15px rgba(0, 123, 255, 0.5); position: relative; z-index: 2001; }
        .loader-profile::before { content: ''; position: absolute; top: 50%; left: 50%; width: 120px; height: 120px; transform: translate(-50%, -50%); border-radius: 50%; background: transparent; border: 2px solid var(--primary-blue); animation: pulse 2s infinite; }
        .loader-spinner { position: absolute; top: -8px; left: -8px; width: 136px; height: 136px; border-radius: 50%; border: 4px solid transparent; border-top-color: var(--primary-blue); animation: spin 1.5s linear infinite; }
        #loader-username { font-size: 22px; font-weight: 600; margin-bottom: 25px; transition: opacity 0.5s ease; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }
        .container { width: 100%; max-width: 500px; margin: 0 auto; display: none; flex-direction: column; min-height: 100vh; padding-top: 60px; padding-bottom: 60px; box-sizing: border-box; }
        .header, .footer-nav { transition: transform 0.3s ease-in-out; }
        .header.hidden, .footer-nav.hidden { transform: translateY(150%); }
        .header.hidden { transform: translateY(-100%); }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; background-color: var(--surface-dark); position: fixed; top: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; z-index: 1000; border-bottom: 1px solid var(--border-color); box-sizing: border-box; }
        .header-profile { display: flex; align-items: center; gap: 12px; }
        .header-profile .profile-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .header-profile .user-info h3 { margin: 0; font-size: 16px; font-weight: 600; }
        .header-profile .user-info p { margin: 0; font-size: 13px; color: var(--text-secondary); }
        .view { display: none; flex-grow: 1; padding: 15px; animation: fadeInView 0.3s ease-in-out; overflow-y: auto; scroll-behavior: smooth; }
        .view.active { display: flex; flex-direction: column; gap: 20px; }
        @keyframes fadeInView { from { opacity: 0; } to { opacity: 1; } }
        .card { background-color: var(--surface-dark); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
        .card h2, .card h3 { margin: 0 0 15px 0; font-size: 20px; font-weight: 600; text-align: center; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:disabled { background-color: #555 !important; color: #999 !important; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-blue); color: white; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stats-item { background-color: var(--surface-dark); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border-color); }
        .stats-item .value { font-size: 28px; font-weight: 700; margin-bottom: 5px; color: var(--primary-blue); }
        .stats-item .label { font-size: 14px; color: var(--text-secondary); }
        .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; background-color: var(--surface-dark); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid var(--border-color); z-index: 1000; }
        .nav-btn { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; font-size: 12px; cursor: pointer; transition: color 0.2s; flex: 1; }
        .nav-btn.active { color: var(--primary-blue); }
        .nav-btn svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; box-sizing: border-box; }
        .modal-content { background-color: var(--surface-dark); width: 100%; max-width: 400px; padding: 20px; border-radius: 12px; animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h3 { margin: 0; }
        .close-modal { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .leaderboard-item { display: flex; align-items: center; background: var(--surface-dark); padding: 10px; border-radius: 8px; margin-bottom:10px;}
        .lb-rank { font-size: 18px; font-weight: bold; color: var(--text-secondary); width: 30px; }
        .lb-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin: 0 10px; }
        .lb-name { font-weight: 600; flex-grow: 1; }
        .lb-balance { font-size: 16px; font-weight: bold; color: var(--primary-green); }
        .withdraw-history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .history-info p { margin: 0; } .history-info .date { font-size: 12px; color: var(--text-secondary); }
        .history-status { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
        .status-pending { background-color: var(--yellow); color: #000; }
        .status-approved { background-color: var(--primary-green); color: #fff; }
        .status-rejected { background-color: var(--red); color: #fff; }
    </style>
</head>
<body>
    <div id="preloader"><div class="loader-profile"><img id="loader-pic" src="" alt="P" class="loader-profile-pic"><div class="loader-spinner"></div></div><h3 id="loader-username">...</h3></div>
    
    <div class="container" id="app-container" style="display:none;">
        <div class="header"><div class="header-profile"><img id="headerProfilePic" src="" alt="P" class="profile-pic"><div class="user-info"><h3 id="userName">...</h3><p id="userBalanceText">...</p></div></div></div>
        
        <div id="home-view" class="view active"><div class="stats-grid"><div class="stats-item"><div class="value" id="balanceValue">0.00</div><div class="label">Balance</div></div><div class="stats-item"><div class="value" id="adsWatchedValue">0/10</div><div class="label">Ads Watched</div></div></div><div class="card"><h3 style="margin-top:0;">Daily Bonus</h3><p>প্রতিদিন আপনার বোনাস সংগ্রহ করুন!</p><button class="btn btn-primary" id="dailyBonusBtn">Claim Bonus</button></div><div class="card"><h3 style="margin-top:0">Start Earning</h3><p>Tasks পেজে গিয়ে বিজ্ঞাপন দেখুন এবং আয় করুন।</p><button id="homeGoToTaskBtn" class="btn btn-primary">Go to Tasks</button></div></div>
        <div id="leaderboard-view" class="view"><div class="card"><h2>Top Earners</h2><div id="leaderboard-list"></div></div></div>
        <div id="tasks-view" class="view"><div class="card"><h3>Official Tasks</h3><p>বিজ্ঞাপন দেখে আয় করুন।</p><button class="btn btn-primary" id="watchAdBtn">Watch Ad (<span id="adRewardText">0.27</span> টাকা)</button></div></div>
        <div id="withdraw-view" class="view"><div class="card"><h3>Withdraw</h3><div class="input-group"><label>Amount</label><input type="number" id="withdrawAmount" placeholder="50"></div><div class="input-group"><label>Method</label><select id="withdrawMethod"><option value="bKash">bKash</option><option value="Nagad">Nagad</option></select></div><div class="input-group"><label>Number</label><input type="text" id="accountNumber" placeholder="01..."></div><button class="btn btn-primary" id="submitWithdraw">Submit</button></div><div class="card"><h3>Withdraw History</h3><div id="withdraw-history-list"></div></div></div>
        <div id="profile-view" class="view"><div class="card" style="align-items:center;"><img id="profilePic" src="" style="width:100px; height:100px; border-radius:50%;"><h3 id="profileName">...</h3><p id="profileUsername">...</p></div><div class="stats-grid"><div class="stats-item"><div class="value" id="profileBalance">0.00</div><div class="label">Balance</div></div><div class="stats-item"><div class="value" id="profileTotalEarnings">0.00</div><div class="label">Total Earned</div></div></div></div>

        <footer class="footer-nav">
            <button class="nav-btn active" data-view="home-view"><span>Home</span></button>
            <button class="nav-btn" data-view="leaderboard-view"><span>Leaders</span></button>
            <button class="nav-btn" data-view="tasks-view"><span>Tasks</span></button>
            <button class="nav-btn" data-view="withdraw-view"><span>Withdraw</span></button>
            <button class="nav-btn" data-view="profile-view"><span>Profile</span></button>
        </footer>

        <div class="modal-overlay" id="welcome-modal"><div class="modal-content"><div class="modal-header"><h3>Welcome!</h3><button class="close-modal">&times;</button></div><p id="welcome-message" style="margin-bottom:15px;"></p><button id="modal-start-earning" class="btn btn-primary">Start Earning</button></div></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCQkckxOt7CC1dvawMpBnF99GW940kitg8",
                authDomain: "promotion-app-38424.firebaseapp.com",
                projectId: "promotion-app-38424",
                storageBucket: "promotion-app-38424.appspot.com",
                messagingSenderId: "216320652641",
                appId: "1:216320652641:web:73106abf936ade4b244120"
            };
            
            let appSettings = { AD_REWARD: 0.27, DAILY_BONUS_AMOUNT: 1, MIN_WITHDRAW_AMOUNT: 50, DAILY_ADS_LIMIT: 10, WELCOME_MESSAGE: "Welcome to our app!" };
            let activeAds = [];
            let currentUser = null;
            let adClickCount = 0;

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const tg = window.Telegram.WebApp;

            const elements = {
                preloader: document.getElementById('preloader'), appContainer: document.getElementById('app-container'),
                loaderPic: document.getElementById('loader-pic'), loaderUsername: document.getElementById('loader-username'),
                header: document.querySelector('.header'), footerNav: document.querySelector('.footer-nav'),
                headerProfilePic: document.getElementById('headerProfilePic'), userName: document.getElementById('userName'),
                userBalanceText: document.getElementById('userBalanceText'), balanceValue: document.getElementById('balanceValue'),
                adsWatchedValue: document.getElementById('adsWatchedValue'), watchAdBtn: document.getElementById('watchAdBtn'),
                adRewardText: document.getElementById('adRewardText'), dailyBonusBtn: document.getElementById('dailyBonusBtn'),
                navButtons: document.querySelectorAll('.nav-btn'), views: document.querySelectorAll('.view'),
                homeGoToTaskBtn: document.getElementById('homeGoToTaskBtn'), leaderboardList: document.getElementById('leaderboard-list'),
                withdrawAmount: document.getElementById('withdrawAmount'), submitWithdraw: document.getElementById('submitWithdraw'),
                withdrawHistoryList: document.getElementById('withdraw-history-list'), profilePic: document.getElementById('profilePic'),
                profileName: document.getElementById('profileName'), profileUsername: document.getElementById('profileUsername'),
                profileBalance: document.getElementById('profileBalance'), profileTotalEarnings: document.getElementById('profileTotalEarnings'),
                welcomeModal: document.getElementById('welcome-modal'), welcomeMessage: document.getElementById('welcome-message'),
                closeModalBtn: document.querySelector('#welcome-modal .close-modal'), modalStartEarningBtn: document.getElementById('modal-start-earning')
            };

            const showView = (viewId) => {
                elements.views.forEach(v => v.classList.remove('active'));
                elements.navButtons.forEach(b => b.classList.remove('active'));
                document.getElementById(viewId)?.classList.add('active');
                document.querySelector(`.nav-btn[data-view="${viewId}"]`)?.classList.add('active');
            };

            try {
                tg.ready();
                tg.expand();
                const tgUser = tg.initDataUnsafe?.user;
                if (!tgUser) throw new Error("Please open via Telegram");

                initUI(tgUser);
                await Promise.all([ fetchAppSettings(), fetchUser(tgUser), fetchActiveAds() ]);
                updateAllUI();
                finishLoadingAnimation(tgUser);
                loadLeaderboard();
                loadWithdrawHistory();

            } catch (error) {
                document.getElementById('preloader').innerHTML = `<div style="text-align:center;padding:20px;">Error: ${error.message}</div>`;
            }

            async function fetchAppSettings() {
                const doc = await db.collection('settings').doc('config').get();
                if (doc.exists) appSettings = { ...appSettings, ...doc.data() };
            }
            async function fetchActiveAds() {
                const snapshot = await db.collection('ads').where('isActive', '==', true).get();
                activeAds = snapshot.docs.map(doc => doc.data());
            }
            async function fetchUser(tgUser) {
                const userRef = db.collection('users').doc(String(tgUser.id));
                const userDoc = await userRef.get();
                const today = new Date().toDateString();

                if (!userDoc.exists) {
                    currentUser = {
                        uid: String(tgUser.id), name: `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim(),
                        photoURL: tgUser.photo_url || 'https://i.ibb.co/L5k6v7R/default-profile.jpg',
                        balance: 0, total_earnings: 0, lastBonusClaimDate: null, adsWatchedToday: 0, lastAdWatchDate: null
                    };
                    await userRef.set(currentUser);
                } else {
                    currentUser = userDoc.data();
                    if (currentUser.lastAdWatchDate !== today) {
                        await userRef.update({ adsWatchedToday: 0, lastAdWatchDate: today });
                        currentUser.adsWatchedToday = 0;
                    }
                }
            }
            
            function initUI(tgUser) {
                const name = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim() || 'Welcome';
                const photo = tgUser.photo_url || 'https://i.ibb.co/L5k6v7R/default-profile.jpg';
                ['loader-pic', 'headerProfilePic', 'profilePic'].forEach(id => document.getElementById(id).src = photo);
                ['loader-username', 'userName', 'profileName'].forEach(id => document.getElementById(id).textContent = name);
            }

            function updateAllUI() {
                if (!currentUser) return;
                const { balance, adsWatchedToday, total_earnings, lastBonusClaimDate } = currentUser;
                
                elements.userBalanceText.textContent = `ব্যালেন্স: ${balance.toFixed(2)} টাকা`;
                elements.balanceValue.textContent = balance.toFixed(2);
                elements.adsWatchedValue.textContent = `${adsWatchedToday}/${appSettings.DAILY_ADS_LIMIT}`;
                elements.adRewardText.textContent = appSettings.AD_REWARD;
                
                elements.profileUsername.textContent = currentUser.username ? `@${currentUser.username}`: '';
                elements.profileBalance.textContent = balance.toFixed(2);
                elements.profileTotalEarnings.textContent = total_earnings.toFixed(2);
                
                elements.watchAdBtn.disabled = adsWatchedToday >= appSettings.DAILY_ADS_LIMIT;
                elements.watchAdBtn.textContent = elements.watchAdBtn.disabled ? 'Daily Limit Reached' : `Watch Ad (${appSettings.AD_REWARD.toFixed(2)} টাকা)`;

                const today = new Date().toDateString();
                elements.dailyBonusBtn.disabled = lastBonusClaimDate === today;
                elements.dailyBonusBtn.textContent = elements.dailyBonusBtn.disabled ? 'Claimed Today' : `Claim ${appSettings.DAILY_BONUS_AMOUNT.toFixed(2)} Taka`;
            }

            function finishLoadingAnimation(tgUser) {
                setTimeout(() => {
                    elements.preloader.style.opacity = '0';
                    setTimeout(() => {
                        elements.preloader.style.display = 'none';
                        elements.appContainer.style.display = 'flex';
                        const isFirstVisit = !localStorage.getItem('visitedBefore');
                        if(isFirstVisit){
                            elements.welcomeMessage.textContent = appSettings.WELCOME_MESSAGE;
                            elements.welcomeModal.style.display = 'flex';
                            localStorage.setItem('visitedBefore', 'true');
                            setTimeout(() => elements.welcomeModal.style.display = 'none', 5000);
                        }
                    }, 500);
                }, 1500);
            }

            async function loadLeaderboard() {
                const list = elements.leaderboardList;
                list.innerHTML = 'Loading...';
                const snapshot = await db.collection('users').orderBy('total_earnings', 'desc').limit(20).get();
                list.innerHTML = '';
                snapshot.forEach((doc, index) => {
                    const user = doc.data();
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `<span class="lb-rank">${index + 1}</span><img src="${user.photoURL}" class="lb-pic"><span class="lb-name">${user.name}</span><span class="lb-balance">${user.total_earnings.toFixed(2)}</span>`;
                    list.appendChild(item);
                });
            }

            async function loadWithdrawHistory() {
                const list = elements.withdrawHistoryList;
                list.innerHTML = 'Loading...';
                const snapshot = await db.collection('withdrawals').where('uid', '==', currentUser.uid).orderBy('requestedAt', 'desc').limit(10).get();
                list.innerHTML = '';
                if(snapshot.empty) { list.innerHTML = 'No history found.'; return; }
                snapshot.forEach(doc => {
                    const req = doc.data();
                    const item = document.createElement('div');
                    item.className = 'withdraw-history-item';
                    const date = req.requestedAt.toDate().toLocaleDateString('bn-BD');
                    item.innerHTML = `<div class="history-info"><p>${req.amount.toFixed(2)} BDT via ${req.method}</p><p class="date">${date}</p></div><span class="history-status status-${req.status}">${req.status}</span>`;
                    list.appendChild(item);
                });
            }

            let lastScroll = 0;
            elements.views.forEach(v => v.addEventListener('scroll', () => {
                const isScrollingDown = v.scrollTop > lastScroll && v.scrollTop > 50;
                elements.header.classList.toggle('hidden', isScrollingDown);
                elements.footerNav.classList.toggle('hidden', isScrollingDown);
                lastScroll = v.scrollTop <= 0 ? 0 : v.scrollTop;
            }));

            elements.navButtons.forEach(btn => btn.addEventListener('click', () => showView(btn.dataset.view)));
            elements.homeGoToTaskBtn.addEventListener('click', () => showView('tasks-view'));
            elements.closeModalBtn.addEventListener('click', () => elements.welcomeModal.style.display = 'none');
            elements.modalStartEarningBtn.addEventListener('click', () => { elements.welcomeModal.style.display = 'none'; showView('tasks-view'); });

            elements.dailyBonusBtn.addEventListener('click', async () => {
                elements.dailyBonusBtn.disabled = true;
                const userRef = db.collection('users').doc(currentUser.uid);
                try {
                    await db.runTransaction(async t => {
                        const doc = await t.get(userRef);
                        const data = doc.data();
                        const today = new Date().toDateString();
                        if (data.lastBonusClaimDate === today) throw new Error("Already claimed");
                        const newBalance = data.balance + appSettings.DAILY_BONUS_AMOUNT;
                        const newTotalEarnings = data.total_earnings + appSettings.DAILY_BONUS_AMOUNT;
                        t.update(userRef, { balance: newBalance, total_earnings: newTotalEarnings, lastBonusClaimDate: today });
                        currentUser.balance = newBalance;
                        currentUser.total_earnings = newTotalEarnings;
                        currentUser.lastBonusClaimDate = today;
                    });
                    tg.showAlert(`You claimed ${appSettings.DAILY_BONUS_AMOUNT.toFixed(2)} Taka!`);
                } catch (e) {
                    tg.showAlert(e.message === "Already claimed" ? "You have already claimed today's bonus." : "Error claiming bonus.");
                } finally {
                    updateAllUI();
                }
            });

            elements.watchAdBtn.addEventListener('click', async () => {
                if (currentUser.adsWatchedToday >= appSettings.DAILY_ADS_LIMIT) { tg.showAlert('Daily ad limit reached.'); return; }
                if (activeAds.length === 0) { tg.showAlert('No ads available right now.'); return; }
                
                elements.watchAdBtn.disabled = true;
                const adToShow = activeAds[adClickCount % activeAds.length];
                let adPromise;
                
                try {
                    // Dynamically load and show ad
                    // This part needs real Ad SDKs to be tested and might need adjustments
                    if (adToShow.adType === 'gigapub') { adPromise = new Promise(resolve => setTimeout(resolve, 3000)); } 
                    else if (adToShow.adType === 'libtl') { adPromise = new Promise(resolve => setTimeout(resolve, 3000)); } 
                    else { throw new Error("Unknown ad type"); }

                    await adPromise; // Simulate watching ad
                    
                    const userRef = db.collection('users').doc(currentUser.uid);
                    await db.runTransaction(async t => {
                        const doc = await t.get(userRef);
                        const newBalance = doc.data().balance + appSettings.AD_REWARD;
                        const newTotalEarnings = doc.data().total_earnings + appSettings.AD_REWARD;
                        const newAdsWatched = doc.data().adsWatchedToday + 1;
                        t.update(userRef, { balance: newBalance, total_earnings: newTotalEarnings, adsWatchedToday: newAdsWatched });
                        currentUser.balance = newBalance;
                        currentUser.total_earnings = newTotalEarnings;
                        currentUser.adsWatchedToday = newAdsWatched;
                    });
                    tg.showAlert(`Congratulations! You earned ${appSettings.AD_REWARD.toFixed(2)} Taka.`);
                } catch (e) {
                    tg.showAlert('Failed to load ad. Please try again.');
                } finally {
                    adClickCount++;
                    updateAllUI();
                }
            });
            
            elements.submitWithdraw.addEventListener('click', async () => {
                 // Logic for withdrawal request
            });
        });
    </script>
</body>
    </html>
