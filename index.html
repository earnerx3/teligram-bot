<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Earning App</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #28a745; --background-color: #f0f2f5;
            --card-background: #ffffff; --text-color: #333333; --light-text-color: #888888; --border-color: #e0e0e0;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--background-color); margin: 0; padding-bottom: 60px; color: var(--text-color); }
        .container { max-width: 450px; margin: 0 auto; background-color: var(--card-background); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); min-height: 100vh; display: flex; flex-direction: column; }
        .header { display: flex; align-items: center; padding: 15px; background-color: var(--card-background); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; }
        .header-icon { font-size: 28px; color: var(--primary-color); margin-right: 10px; }
        .header-title { font-size: 20px; font-weight: 600; color: var(--text-color); }
        .content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .card { background-color: #fff; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); text-align: center; border: 1px solid var(--border-color); }
        .card-header { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--text-color); display: flex; align-items: center; justify-content: center; }
        .card-header .material-icons, .card-header .fa-solid { margin-right: 8px; color: var(--primary-color); }
        .balance-card .balance { font-size: 36px; font-weight: 700; color: var(--secondary-color); margin: 10px 0; }
        .card-label { font-size: 14px; color: var(--light-text-color); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .dashboard-item { background-color: var(--card-background); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); text-align: center; }
        .dashboard-item .material-icons, .dashboard-item .fa-solid { font-size: 32px; margin-bottom: 10px; color: var(--primary-color); }
        .dashboard-item-value { font-size: 24px; font-weight: 700; color: var(--text-color); }
        .dashboard-item-label { font-size: 12px; color: var(--light-text-color); }
        .primary-btn, .secondary-btn { border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: background-color 0.3s, transform 0.2s; margin-top: 20px; }
        .primary-btn { background-color: var(--primary-color); color: #fff; }
        .primary-btn:hover { background-color: #0056b3; transform: translateY(-2px); }
        .primary-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .secondary-btn { background-color: #f0f0f0; color: var(--text-color); border: 1px solid var(--border-color); }
        .secondary-btn:hover { background-color: #e0e0e0; transform: translateY(-2px); }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); box-sizing: border-box; font-size: 16px; }
        .profile-info { background-color: var(--card-background); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); margin-top: 20px; }
        .profile-info-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .profile-info-row:last-child { border-bottom: none; }
        .profile-label { font-size: 16px; color: var(--text-color); }
        .profile-value { font-size: 16px; font-weight: 600; color: var(--primary-color); }
        .progress-bar-container { height: 10px; background-color: #eee; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; background-color: var(--primary-color); width: 0; transition: width 0.5s ease-in-out; }
        .footer-nav { display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; width: 100%; max-width: 450px; background-color: var(--card-background); border-top: 1px solid var(--border-color); box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 10px; cursor: pointer; color: var(--light-text-color); transition: color 0.3s; flex: 1; }
        .nav-item .material-icons, .nav-item .fa-solid { font-size: 24px; margin-bottom: 5px; }
        .nav-item-label { font-size: 12px; font-weight: 500; }
        .nav-item.active { color: var(--primary-color); }
        .page { display: none; }
        .page.active { display: block; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>

    <div class="container" style="visibility: hidden;">
        <header class="header">
            <span class="material-icons header-icon">rocket_launch</span>
            <span class="header-title" id="header-title">My Earning App</span>
        </header>

        <main class="content">
            <section id="home-page" class="page active">
                <div class="card balance-card">
                    <h2 class="card-header"><span class="material-icons">account_balance_wallet</span>My Balance</h2>
                    <div class="balance" id="current-balance">BDT 0.00</div>
                    <button class="secondary-btn" data-page-target="withdraw-page">Withdraw <span class="material-icons" style="font-size: 16px;">currency_exchange</span></button>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-item">
                        <span class="material-icons" style="color: var(--secondary-color);">payments</span>
                        <div class="dashboard-item-value" id="total-earnings">BDT 0.00</div>
                        <div class="dashboard-item-label">Total Earnings</div>
                    </div>
                    <div class="dashboard-item">
                        <span class="material-icons" style="color: #ffc107;">preview</span>
                        <div class="dashboard-item-value" id="ads-watched">0</div>
                        <div class="dashboard-item-label">Ads Watched Today</div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                     <h2 class="card-header"><span class="material-icons" style="color: #ff9800;">card_giftcard</span>Daily Bonus</h2>
                     <button class="primary-btn" id="daily-bonus-btn">Claim Bonus</button>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2 class="card-header"><span class="material-icons" style="color: #03a9f4;">share</span>Share with Friends</h2>
                     <p style="font-size: 13px; color: var(--light-text-color); margin-bottom: 15px;">Share your link with friends and help them earn.</p>
                    <div class="form-group" style="margin-bottom: 0;">
                        <input type="text" id="referral-link-input" readonly value="Loading link...">
                    </div>
                </div>
            </section>

            <section id="earn-page" class="page">
                <div class="card">
                    <h2 class="card-header"><span class="material-icons">monetization_on</span>Earn Rewards</h2>
                    <div style="text-align: left; margin-bottom: 10px;">
                        <div style="font-size: 14px; font-weight: 600;">Today's Progress:</div>
                        <div style="font-size: 12px; color: var(--light-text-color);" id="ad-progress-text">Completed: 0 / 10</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="ad-progress-bar"></div>
                    </div>
                    <button class="primary-btn" id="watch-ad-btn">Watch Ad & Earn<span class="material-icons" style="font-size: 16px;">play_circle_filled</span></button>
                </div>
            </section>
            
            <section id="withdraw-page" class="page">
                <div class="card">
                    <h2 class="card-header"><span class="material-icons">currency_exchange</span>Withdraw Your Earnings</h2>
                    <div class="balance" id="withdraw-balance-display">BDT 0.00</div>
                    <div class="card-label">Current Balance</div>
                    <div id="min-withdraw-text" style="margin-top: 20px; font-size: 14px; color: var(--light-text-color);"></div>
                </div>
                
                <div class="profile-info">
                    <h4 style="margin-top: 0;">Withdraw Details</h4>
                    <form id="withdraw-form">
                        <div class="form-group"><label for="withdraw-method">Withdraw Method</label><select id="withdraw-method" required><option value="" disabled selected>Select a method</option><option value="bkash">bKash</option><option value="binance">Binance</option></select></div>
                        <div class="form-group"><label for="account-number">Account Number</label><input type="text" id="account-number" placeholder="Enter account number" required></div>
                        <div class="form-group"><label for="withdraw-amount">Amount (BDT)</label><input type="number" id="withdraw-amount" placeholder="Enter amount to withdraw" required></div>
                        <button type="submit" class="primary-btn" id="submit-withdraw-btn">Submit Withdraw Request</button>
                    </form>
                </div>
            </section>

            <section id="profile-page" class="page">
                <div class="card" style="padding: 30px;">
                    <img id="profile-pic" src="https://via.placeholder.com/80" alt="Profile Picture" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 15px; border: 2px solid var(--primary-color);">
                    <h3 id="profile-name" style="margin: 0; font-weight: 600;">...</h3>
                    <p id="profile-username" style="margin: 5px 0 0; color: var(--light-text-color); font-size: 14px;">...</p>
                </div>
                <div class="profile-info">
                    <h4 style="margin-top: 0;">My Profile</h4>
                    <div class="profile-info-row"><span class="profile-label">Current Balance</span><span class="profile-value" id="profile-balance">BDT 0.00</span></div>
                    <div class="profile-info-row"><span class="profile-label">Total Earnings</span><span class="profile-value" id="profile-earnings">BDT 0.00</span></div>
                    <div class="profile-info-row"><span class="profile-label">Ads Watched Today</span><span class="profile-value" id="profile-ads-watched">0</span></div>
                </div>
            </section>
        </main>

        <nav class="footer-nav">
            <div class="nav-item active" data-page="home-page"><span class="material-icons">home</span><span class="nav-item-label">Home</span></div>
            <div class="nav-item" data-page="earn-page"><span class="material-icons">play_circle</span><span class="nav-item-label">Earn</span></div>
            <div class="nav-item" data-page="withdraw-page"><span class="fa-solid fa-credit-card"></span><span class="nav-item-label">Withdraw</span></div>
            <div class="nav-item" data-page="profile-page"><span class="material-icons">person</span><span class="nav-item-label">Profile</span></div>
        </nav>
    </div>

    <script src='//libtl.com/sdk.js' data-zone='9702412' data-sdk='show_9702412'></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ==========================================================
            // STEP 1: Paste Your Firebase Configuration Here
            // ==========================================================
            const firebaseConfig = {
                apiKey: "AIzaSyCQkckxOt7CC1dvawMpBnF99GW940kitg8",
                authDomain: "promotion-app-38424.firebaseapp.com",
                databaseURL: "https://promotion-app-38424-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "promotion-app-38424",
                storageBucket: "promotion-app-38424.appspot.com",
                messagingSenderId: "216320652641",
                appId: "1:216320652641:web:73106abf936ade4b244120",
                measurementId: "G-76MH7NH873"
            };
            
            // ==========================================================
            // STEP 2: Enter Your Bot's Username Here (for referral link)
            // ==========================================================
            const BOT_USERNAME = "YourBotUsername";

            // --- Default App Settings (will be overwritten by Firebase) ---
            let appSettings = {
                AD_REWARD: 0.27,
                MIN_WITHDRAW_AMOUNT: 50.00,
                DAILY_BONUS_AMOUNT: 0.50,
                DAILY_ADS_LIMIT: 10
            };

            // --- Initialize Firebase and Telegram ---
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const tg = window.Telegram.WebApp;

            // --- Get HTML Elements ---
            const loader = document.getElementById('loader');
            const mainContainer = document.querySelector('.container');
            const navItems = document.querySelectorAll('.nav-item');
            const pages = document.querySelectorAll('.page');
            const watchAdBtn = document.getElementById('watch-ad-btn');
            const dailyBonusBtn = document.getElementById('daily-bonus-btn');
            const withdrawForm = document.getElementById('withdraw-form');
            const pageSwitchButtons = document.querySelectorAll('[data-page-target]');

            let currentUserData = null;

            // --- Main Function to Start the App ---
            async function main() {
                try {
                    tg.ready();
                    tg.expand();

                    const localData = localStorage.getItem('userData');
                    if (localData) {
                        currentUserData = JSON.parse(localData);
                        updateUI(tg.initDataUnsafe?.user || {first_name: 'User'});
                        mainContainer.style.visibility = 'visible';
                        loader.style.display = 'none'; 
                    }
                    
                    await fetchAppSettings();

                    const tgUser = tg.initDataUnsafe?.user;
                    if (!tgUser) throw new Error("Please open this app inside Telegram.");
                    
                    currentUserData = await getUserOrCreateAccount(tgUser);
                    localStorage.setItem('userData', JSON.stringify(currentUserData));
                    
                    updateUI(tgUser);
                    mainContainer.style.visibility = 'visible';
                    loader.style.display = 'none';

                } catch (error) {
                    console.error("Critical Error:", error);
                    loader.innerText = `Error: ${error.message}`;
                }
            }

            async function fetchAppSettings() {
                try {
                    const settingsRef = db.collection('settings').doc('config');
                    const doc = await settingsRef.get();
                    if (doc.exists) {
                        appSettings = { ...appSettings, ...doc.data() };
                    }
                } catch (error) {
                    console.error("Error fetching settings:", error);
                }
            }

            async function getUserOrCreateAccount(tgUser) {
                const userRef = db.collection('users').doc(String(tgUser.id));
                const doc = await userRef.get();
                const today = new Date().toISOString().split('T')[0];

                if (!doc.exists) {
                    const newUser = {
                        telegram_id: tgUser.id, first_name: tgUser.first_name || 'User', username: tgUser.username || null,
                        balance: 0, total_earnings: 0, ads_watched_today: 0,
                        last_watched_date: today, last_bonus_claimed_date: null,
                    };
                    await userRef.set(newUser);
                    return newUser;
                } else {
                    let data = doc.data();
                    if (data.last_watched_date !== today) {
                        await userRef.update({ ads_watched_today: 0, last_watched_date: today });
                        data.ads_watched_today = 0;
                    }
                    return data;
                }
            }
            
            function updateUI(tgUser) {
                if (!currentUserData) return;
                
                const { balance = 0, total_earnings = 0, ads_watched_today = 0, last_bonus_claimed_date } = currentUserData;
                const today = new Date().toISOString().split('T')[0];
                
                document.getElementById('current-balance').textContent = `BDT ${balance.toFixed(2)}`;
                document.getElementById('total-earnings').textContent = `BDT ${total_earnings.toFixed(2)}`;
                document.getElementById('ads-watched').textContent = ads_watched_today;
                document.getElementById('ad-progress-text').textContent = `Completed: ${ads_watched_today} / ${appSettings.DAILY_ADS_LIMIT}`;
                document.getElementById('ad-progress-bar').style.width = `${(ads_watched_today / appSettings.DAILY_ADS_LIMIT) * 100}%`;
                
                watchAdBtn.disabled = ads_watched_today >= appSettings.DAILY_ADS_LIMIT;
                watchAdBtn.textContent = watchAdBtn.disabled ? 'Daily Limit Reached' : 'Watch Ad & Earn';
                
                document.getElementById('min-withdraw-text').textContent = `Minimum withdraw: BDT ${appSettings.MIN_WITHDRAW_AMOUNT.toFixed(2)}`;
                document.getElementById('withdraw-amount').min = appSettings.MIN_WITHDRAW_AMOUNT;
                document.getElementById('withdraw-balance-display').textContent = `BDT ${balance.toFixed(2)}`;
                document.getElementById('submit-withdraw-btn').disabled = balance < appSettings.MIN_WITHDRAW_AMOUNT;

                document.getElementById('profile-pic').src = tgUser.photo_url || 'https://via.placeholder.com/80';
                document.getElementById('profile-name').textContent = tgUser.first_name;
                document.getElementById('profile-username').textContent = tgUser.username ? `@${tgUser.username}` : '';
                document.getElementById('profile-balance').textContent = `BDT ${balance.toFixed(2)}`;
                document.getElementById('profile-earnings').textContent = `BDT ${total_earnings.toFixed(2)}`;
                document.getElementById('profile-ads-watched').textContent = ads_watched_today;

                document.getElementById('referral-link-input').value = `https://t.me/${BOT_USERNAME}?start=${tgUser.id}`;

                dailyBonusBtn.disabled = last_bonus_claimed_date === today;
                dailyBonusBtn.textContent = dailyBonusBtn.disabled ? 'Bonus Claimed Today' : `Claim Bonus (BDT ${appSettings.DAILY_BONUS_AMOUNT.toFixed(2)})`;
            }

            function showPage(targetPageId) {
                navItems.forEach(nav => nav.classList.remove('active'));
                pages.forEach(page => page.classList.remove('active'));
                const activeNavItem = document.querySelector(`[data-page="${targetPageId}"]`);
                if (activeNavItem) activeNavItem.classList.add('active');
                const activePage = document.getElementById(targetPageId);
                if (activePage) activePage.classList.add('active');
            }
            navItems.forEach(item => { item.addEventListener('click', () => showPage(item.getAttribute('data-page'))); });
            pageSwitchButtons.forEach(btn => { btn.addEventListener('click', () => showPage(btn.getAttribute('data-page-target'))); });

            dailyBonusBtn.addEventListener('click', async () => {
                dailyBonusBtn.disabled = true; dailyBonusBtn.textContent = 'Claiming...';
                const today = new Date().toISOString().split('T')[0];
                const userRef = db.collection('users').doc(String(tg.initDataUnsafe.user.id));
                try {
                    await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(userRef);
                        if (!doc.exists) throw new Error("User not found.");
                        if (doc.data().last_bonus_claimed_date === today) throw new Error("Bonus already claimed today.");
                        const newBalance = (doc.data().balance || 0) + appSettings.DAILY_BONUS_AMOUNT;
                        const newTotalEarnings = (doc.data().total_earnings || 0) + appSettings.DAILY_BONUS_AMOUNT;
                        transaction.update(userRef, { balance: newBalance, total_earnings: newTotalEarnings, last_bonus_claimed_date: today });
                        currentUserData = {...currentUserData, balance: newBalance, total_earnings: newTotalEarnings, last_bonus_claimed_date: today};
                    });
                    localStorage.setItem('userData', JSON.stringify(currentUserData));
                    alert(`Bonus claimed! You received BDT ${appSettings.DAILY_BONUS_AMOUNT.toFixed(2)}.`);
                } catch (e) {
                    alert(e.message);
                } finally {
                    updateUI(tg.initDataUnsafe.user);
                }
            });

            watchAdBtn.addEventListener('click', async () => {
                watchAdBtn.disabled = true; watchAdBtn.textContent = 'Loading Ad...';
                try {
                    if (typeof show_9702412 !== 'function') throw new Error("Ad SDK not available.");
                    await show_9702412();
                    const userRef = db.collection('users').doc(String(tg.initDataUnsafe.user.id));
                    await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(userRef);
                        if (!doc.exists) throw new Error("User not found.");
                        const newBalance = (doc.data().balance || 0) + appSettings.AD_REWARD;
                        const newTotalEarnings = (doc.data().total_earnings || 0) + appSettings.AD_REWARD;
                        const newAdsWatchedToday = (doc.data().ads_watched_today || 0) + 1;
                        transaction.update(userRef, { balance: newBalance, total_earnings: newTotalEarnings, ads_watched_today: newAdsWatchedToday });
                        currentUserData = {...currentUserData, balance: newBalance, total_earnings: newTotalEarnings, ads_watched_today: newAdsWatchedToday};
                    });
                    localStorage.setItem('userData', JSON.stringify(currentUserData));
                    alert(`Congratulations! You have earned BDT ${appSettings.AD_REWARD.toFixed(2)}.`);
                } catch (e) {
                    alert('Failed to show ad or update balance.');
                } finally {
                    updateUI(tg.initDataUnsafe.user);
                }
            });
            
            withdrawForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = document.getElementById('submit-withdraw-btn');
                submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';
                const amount = parseFloat(document.getElementById('withdraw-amount').value);
                const accountNumber = document.getElementById('account-number').value;
                const method = document.getElementById('withdraw-method').value;
                if (currentUserData.balance < amount) { alert('Insufficient balance.'); updateUI(tg.initDataUnsafe.user); return; }
                try {
                    const withdrawRef = db.collection('withdrawals').doc();
                    const userRef = db.collection('users').doc(String(tg.initDataUnsafe.user.id));
                    await db.runTransaction(async (transaction) => {
                        const userDoc = await transaction.get(userRef);
                        if (!userDoc.exists) throw new Error("User not found.");
                        const newBalance = userDoc.data().balance - amount;
                        if (newBalance < 0) throw new Error("Balance cannot go below zero.");
                        transaction.set(withdrawRef, {
                            userId: tg.initDataUnsafe.user.id, userName: tg.initDataUnsafe.user.first_name,
                            amount: amount, method: method, accountNumber: accountNumber, status: 'pending',
                            requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        transaction.update(userRef, { balance: newBalance });
                        currentUserData.balance = newBalance;
                    });
                    localStorage.setItem('userData', JSON.stringify(currentUserData));
                    alert('Withdrawal request submitted successfully.');
                    withdrawForm.reset();
                    showPage('home-page');
                } catch (error) {
                    alert('Failed to submit request.');
                } finally {
                    updateUI(tg.initDataUnsafe.user);
                }
            });
            main();
        });
    </script>
</body>
</html>
